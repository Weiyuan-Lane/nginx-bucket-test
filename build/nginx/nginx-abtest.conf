upstream a {
  server 127.0.0.1:8080;
  keepalive 32;
}

upstream b {
  server 127.0.0.1:8081;
  keepalive 32;
}

upstream c {
  server 127.0.0.1:8082;
  keepalive 32;
}

include fragments/abtest-100-config;

map $abtest_bucket_val $proxy_val {
  # 10% : 0 - 9
  ~^[0-9]$ 'a';

  # 15% : 10 - 24
  ~^((2[0-4])|(1[0-9]))$ 'b';

  # 75% : 25 - 99
  ~^(([3-9][0-9])|(2[5-9]))$ 'c';
  
  default 'a';
}

server {
  listen 80;
  listen 443;
  server_name _;

  location / {
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;
    proxy_set_header Host $host;
    include fragments/add-header-bucket-cookie;

    proxy_pass http://$proxy_val;
  }
}